@using HomeFinder.Models;
@using Microsoft.AspNetCore.Components;
@using Microsoft.AspNetCore.Components.Web;
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Identity;
@using System;
@using System.IO;
@using System.Collections.Generic;
@using System.Net.NetworkInformation;
@using System.Threading.Tasks;
@using Microsoft.EntityFrameworkCore;
@using HomeFinder.Data;
@using System.Linq;
@inject IHttpContextAccessor httpContextAccessor
@inject HomeFinderContext context
<style>

    #properties-container {
         display: flex;
    }

    #properties-container > div {
        min-height: 553px;
        width : 33%;
        /*border : 1px solid;*/
    }

    #left-side .card-body {
        padding: 0;
        width : 100%;
    }
    
    #left-side > div {
        height: 43%;
        overflow-y : auto;
    }

    #left-side > h4 {
        height: 5%;
    }

    .card-body > a {
        background-color: #eee;
        color: black;
        display: block;
        padding: 20px;
        text-decoration: none;
    }

        p {
        color: black;
    }

    #main {
  margin: 50px 0;
}

#main #faq .card {
  margin-bottom: 2px;
  border: 0;
}

#main #faq .card .card-header {
  border: 0;
  -webkit-box-shadow: 0 0 20px 0 rgba(213, 213, 213, 0.5);
          box-shadow: 0 0 20px 0 rgba(213, 213, 213, 0.5);
  border-radius: 2px;
  padding: 0;
}

#main #faq .card .card-header .btn-header-link {
  color: #fff;
  display: block;
  text-align: left;
  background: #grey;
  color: #222;
  padding: 20px;
}

#main #faq .card .card-header .btn-header-link:after {
  content: "\f107";
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  float: right;
}

#main #faq .card .card-header .btn-header-link.collapsed {
  background: #e48153;
  color: #fff;
}

#main #faq .card .card-header .btn-header-link.collapsed:after {
  content: "\f106";
}

#main #faq .card .collapsing {
  background: #fff;
  line-height: 30px;
}

#main #faq .card .collapse {
  border: 0;
}

#main #faq .card .collapse.show {
  background: #fff;
  line-height: 30px;
  color: #222;
}

h4 {
    background-color: #DDDDDD;
}

.card-text {
    margin: 0;
}

.card-img {
    width: 300px;
    height: 200px;
}

</style>

<div id="properties-container">
    <div id="left-side" class="text-center">
        <h4>Properties</h4> 
        <div id="left-over">
                  
            <div class="card bg-light" style="min-height: 80%">
                <div class="card-body">
                    <div class="btn-group btn-group-toggle" style="display:block;" data-toggle="buttons">
                        @foreach (var property in propertyObjects)
                        {
                            <label class="btn btn-primary" @onclick="() => SetProperty(property)"  for="@property.Id">
                            <input type="radio" class="btn-check" name="options-outlined" id="@property.Id" autocomplete="off">
                            @property.Address.FullAddress</label>
                        }
                    </div>
                </div>
            </div>
        </div>
        <h4>Notice of interests</h4> 
        <div id="left-under" class="text-center">
            <div class="card bg-light" style="min-height: 50%">
                <div class="card-body" style="min-height: 100%">
                    <div class="btn-group btn-group-toggle" style="display:block;" data-toggle="buttons" id="notice-of-interests">
                        @if (noticeOfInterests==null)
                        {
                            <h6 class="mt-3">Select Address to see notice of interests</h6>
                        }
                        else if(noticeOfInterests.Count()==0)
                        {
                            <h6 class="mt-3">There is no notice of interests to this property</h6>
                        }
                        else
                        {
                            @foreach (var person in noticeOfInterests)
                            {
                                <label class="btn btn-primary" style="width: 100%" @onclick="() => GetPersonalInfo(person)">
                                <input type="radio" class="btn-check" name="options" id="option+@person.Id" autocomplete="off"> @person.FirstName @person.LastName
                                </label>
                            }                  
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="middle-side" class="text-center">
        <div class="card bg-light" style="min-height: 100%">
             <div class="card-title"><h4>Contact</h4></div>
                  <div class="card-body">
                    @if (UserToDisplay==null)
                    {
                    <h6 class="card-text mt-3">Select User to see more info</h6>
                    }
                    else
                    {
                    <h5 class="card-title">Info</h5>
                    <p class="card-text"><strong>Firstname:</strong> @UserToDisplay.FirstName</p>
                    <p class="card-text"><strong>Lastname:</strong> @UserToDisplay.LastName</p>
                    <p class="card-text"><strong>E-mail:</strong> @UserToDisplay.Email</p>
                    <p class="card-text"><strong>Address:</strong> @UserToDisplay.Address.FullAddress</p>
                    }
                  </div>
        </div>
    </div>
    <div id="right-side" class="text-center">
        <div class="card-title"><h4>Selected object</h4></div>
      @if (propertyObjectToDisplay==null)
      {
         <h6 class="mt-3">Select Adress to see more info</h6>
      }
      else
      {
            
        <div class="card">
            <div class="card-body">
                @if (propertyObjectToDisplay.Images != null)
                {

                    <img class="card-img" src="@propertyObjectToDisplay.Images[0].Path" asp-append-version="true"/>
                }
                <div class="card-title">
                    @propertyObjectToDisplay.Address.StreetAddress,
                    @propertyObjectToDisplay.Address.PostalCode
                    @propertyObjectToDisplay.Address.City
                    @propertyObjectToDisplay.Address.Country
                </div>
                <p class="card-text"><strong>Description:</strong> @propertyObjectToDisplay.Description</p>
                <p class="card-text"><strong>Number of rooms:</strong> @propertyObjectToDisplay.NumberOfRooms rooms</p>
                <p class="card-text"><strong>Area:</strong> @propertyObjectToDisplay.Area m²</p>
                <p class="card-text"><strong>Type:</strong> @propertyObjectToDisplay.PropertyType.PropertyTypeName</p>
                <p class="card-text"><strong>Realtor:</strong> @propertyObjectToDisplay.Realtor.FirstName @propertyObjectToDisplay.Realtor.LastName</p>
                <p class="card-text"><strong>E-mail:</strong> @propertyObjectToDisplay.Realtor.Email</p>
                <p class="card-text"><strong>Phone number:</strong> @propertyObjectToDisplay.Realtor.PhoneNumber</p>

            </div>
            <div class="card-footer">
                <a href="PropertyObjects/Edit/@propertyObjectToDisplay.Id">Edit</a> |
                <a href="PropertyObjects/Details/@propertyObjectToDisplay.Id">Details</a> |
                <a href="PropertyObjects/Delete/@propertyObjectToDisplay.Id">Delete</a>
            </div>
        </div>
        }
    </div>
</div>

@code {

    public IEnumerable<PropertyObject> propertyObjects { get; set; }

    public PropertyObject propertyObjectToDisplay { get; set; }

    public List<HomeFinderUser> noticeOfInterests { get; set; }

    public HomeFinderUser Realtor { get; set; }

    public HomeFinderUser UserToDisplay { get; set; }

    public string UserName;

    public void GetRealtor()
    {
        UserName = httpContextAccessor.HttpContext.User.Identity.Name;
        Realtor = context.Users.FirstOrDefault(i => i.Email == UserName);

    }

    protected override void OnInitialized()
    {
        GetRealtor();
        propertyObjects = GetProperties();
        ChangeImagePath();
    }



    public void SetProperty(PropertyObject property)
    {
        noticeOfInterests = new List<HomeFinderUser>();
        UserToDisplay = null;
        propertyObjectToDisplay = property;
        noticeOfInterests = SetNoticeOfInterests();
    }

    public void GetPersonalInfo(HomeFinderUser user)
    {
        UserToDisplay = user;
    }

    public List<HomeFinderUser> SetNoticeOfInterests()
    {
        List<HomeFinderUser> listToSend = new();

        foreach (var item in context.NoticeOfInterests.Include(n => n.User).ThenInclude(u => u.Address).ToList())
        {
            if (item.PropertyObject==propertyObjectToDisplay)
            {
                listToSend.Add(item.User);
            }
        }

        return listToSend;
    }

    public IEnumerable<PropertyObject> GetProperties()
    {
        return context.PropertyObjects.Where(p => p.RealtorId == Realtor.Id).Include(p => p.Address).Include(p => p.Realtor).Include(p => p.PropertyType).Include(p => p.Images).ToList();
    }

    public IEnumerable<PropertyObject> ChangeImagePath()
    {
        propertyObjects = GetProperties();
        foreach(var property in propertyObjects)
        {
            foreach(var image in property.Images)
            {
               var splited = image.Path.Split("/");
               image.Path = splited[1] + "/" + splited[2];
                
            }
        }
        return propertyObjects;
    }
}

